<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>British Jazz Network Visualiser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            opacity: 0.8;
            font-size: 1.1rem;
        }

        .api-setup {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            text-align: center;
        }

        .api-setup input {
            width: 300px;
            margin: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        select, input, button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        select:hover, input:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        select:focus, input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: #ffd700;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .network-container {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px 15px 0 0;
            overflow: hidden;
        }

        #network {
            width: 100%;
            height: 70vh;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .artist-info {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .artist-info.active {
            display: block;
        }

        .artist-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .collaborations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .collaboration {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #4ecdc4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .status-message {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loading::after {
            content: '...';
            animation: pulse 1.5s infinite;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
            
            #network {
                height: 50vh;
            }

            .api-setup input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>British Jazz Network</h1>
        <p class="subtitle">Exploring collaborations in contemporary British jazz</p>
    </div>

    <div class="api-setup">
        <h3>ðŸŽµ Connect to Live Music Data</h3>
        <p>Enter your Discogs API token to fetch real collaboration data</p>
        <input type="password" id="apiToken" placeholder="Enter your Discogs API token">
        <button id="saveToken">Save Token</button>
        <div id="apiStatus"></div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="artistSelect">Select Seed Artist:</label>
            <select id="artistSelect">
                <option value="shabaka-hutchings">Shabaka Hutchings</option>
                <option value="nubya-garcia">Nubya Garcia</option>
                <option value="moses-boyd">Moses Boyd</option>
                <option value="kamaal-williams">Kamaal Williams</option>
                <option value="ezra-collective">Ezra Collective</option>
                <option value="kokoroko">Kokoroko</option>
                <option value="theon-cross">Theon Cross</option>
                <option value="joe-armon-jones">Joe Armon-Jones</option>
                <option value="steam-down">Steam Down</option>
                <option value="binker-moses">Binker and Moses</option>
                <option value="alfa-mist">Alfa Mist</option>
                <option value="yussef-dayes">Yussef Dayes</option>
            </select>
        </div>

        <div class="control-group">
            <label for="roleFilter">Filter by Role:</label>
            <select id="roleFilter">
                <option value="all">All Roles</option>
                <option value="performer">Performers Only</option>
                <option value="producer">Producers Only</option>
                <option value="composer">Composers Only</option>
            </select>
        </div>

        <div class="control-group">
            <label for="degreeSlider">Degrees of Separation:</label>
            <input type="range" id="degreeSlider" min="1" max="2" value="1" style="width: 150px;">
            <span id="degreeValue">1</span>
        </div>

        <button id="generateNetwork">Generate Network</button>
    </div>

    <div class="network-container">
        <div id="network"></div>
    </div>

    <div class="info-panel">
        <div id="defaultInfo">
            <h3>Welcome to the British Jazz Network Visualiser</h3>
            <p>Select an artist above and click "Generate Network" to explore their collaborations. Click on any node in the network to see detailed information about that artist and their connections.</p>
            <p><strong>Getting Started:</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>Get a free Discogs API token at <a href="https://www.discogs.com/settings/developers" target="_blank" style="color: #ffd700;">discogs.com/settings/developers</a></li>
                <li>Enter your token above to connect to live music data</li>
                <li>Or use the demo with sample data (no token required)</li>
            </ul>
        </div>
        
        <div id="artistInfo" class="artist-info">
            <div class="artist-name" id="selectedArtistName"></div>
            <div id="artistDetails"></div>
            <div class="collaborations" id="collaborationsList"></div>
        </div>
    </div>

    <script>
        // Sample data as fallback when API is not available
        const fallbackData = {
            'shabaka-hutchings': {
                name: 'Shabaka Hutchings',
                collaborations: [
                    { artist: 'Sons of Kemet', type: 'band-member', album: 'Your Queen Is a Reptile' },
                    { artist: 'The Comet Is Coming', type: 'band-member', album: 'Trust in the Lifeforce of the Deep Mystery' },
                    { artist: 'Nubya Garcia', type: 'performer', album: 'Source' },
                    { artist: 'Moses Boyd', type: 'performer', album: 'Dark Matter' },
                    { artist: 'Kamaal Williams', type: 'collaborator', album: 'The Return' }
                ]
            },
            'nubya-garcia': {
                name: 'Nubya Garcia',
                collaborations: [
                    { artist: 'Shabaka Hutchings', type: 'performer', album: 'Source' },
                    { artist: 'Joe Armon-Jones', type: 'performer', album: 'Starting Today' },
                    { artist: 'Ezra Collective', type: 'guest', album: 'You Cant Steal My Joy' },
                    { artist: 'Moses Boyd', type: 'performer', album: 'Dark Matter' },
                    { artist: 'Kokoroko', type: 'collaborator', album: 'Could We Be More' }
                ]
            },
            'moses-boyd': {
                name: 'Moses Boyd',
                collaborations: [
                    { artist: 'Shabaka Hutchings', type: 'performer', album: 'Dark Matter' },
                    { artist: 'Nubya Garcia', type: 'performer', album: 'Source' },
                    { artist: 'Zara McFarlane', type: 'producer', album: 'Songs of an Unknown Tongue' },
                    { artist: 'Binker and Moses', type: 'band-member', album: 'Dem Ones' },
                    { artist: 'Theon Cross', type: 'collaborator', album: 'Fyah' }
                ]
            },
            'kamaal-williams': {
                name: 'Kamaal Williams',
                collaborations: [
                    { artist: 'Yussef Kamaal', type: 'band-member', album: 'Black Focus' },
                    { artist: 'Shabaka Hutchings', type: 'collaborator', album: 'The Return' },
                    { artist: 'Joe Armon-Jones', type: 'collaborator', album: 'Starting Today' },
                    { artist: 'Wu-Lu', type: 'producer', album: 'LOGGERHEAD' }
                ]
            },
            'ezra-collective': {
                name: 'Ezra Collective',
                collaborations: [
                    { artist: 'Nubya Garcia', type: 'guest', album: 'You Cant Steal My Joy' },
                    { artist: 'Loyle Carner', type: 'collaborator', album: 'Yesterday\'s Gone' },
                    { artist: 'Jorja Smith', type: 'backing-band', album: 'Lost & Found' },
                    { artist: 'Steam Down', type: 'collective-member', album: 'Five Fruit' }
                ]
            },
            'kokoroko': {
                name: 'Kokoroko',
                collaborations: [
                    { artist: 'Nubya Garcia', type: 'collaborator', album: 'Could We Be More' },
                    { artist: 'Steam Down', type: 'collective-member', album: 'Five Fruit' },
                    { artist: 'Ezra Collective', type: 'peer-group', album: 'Jazz Re:freshed Compilation' }
                ]
            },
            'theon-cross': {
                name: 'Theon Cross',
                collaborations: [
                    { artist: 'Sons of Kemet', type: 'band-member', album: 'Your Queen Is a Reptile' },
                    { artist: 'Moses Boyd', type: 'collaborator', album: 'Fyah' },
                    { artist: 'Kassa Overall', type: 'guest', album: 'Animals' },
                    { artist: 'Shabaka Hutchings', type: 'band-mate', album: 'Black to Comm' }
                ]
            },
            'joe-armon-jones': {
                name: 'Joe Armon-Jones',
                collaborations: [
                    { artist: 'Nubya Garcia', type: 'performer', album: 'Starting Today' },
                    { artist: 'Kamaal Williams', type: 'collaborator', album: 'The Return' },
                    { artist: 'Ezra Collective', type: 'session-musician', album: 'You Cant Steal My Joy' },
                    { artist: 'Steam Down', type: 'collective-member', album: 'Five Fruit' }
                ]
            },
            'steam-down': {
                name: 'Steam Down',
                collaborations: [
                    { artist: 'Kokoroko', type: 'collective-member', album: 'Five Fruit' },
                    { artist: 'Ezra Collective', type: 'peer-group', album: 'Jazz Re:freshed' }
                ]
            },
            'binker-moses': {
                name: 'Binker and Moses',
                collaborations: [
                    { artist: 'Moses Boyd', type: 'band-member', album: 'Dem Ones' }
                ]
            },
            'alfa-mist': {
                name: 'Alfa Mist',
                collaborations: [
                    { artist: 'Jordan Rakei', type: 'collaborator', album: 'Antiphon' }
                ]
            },
            'yussef-dayes': {
                name: 'Yussef Dayes',
                collaborations: [
                    { artist: 'Alfa Mist', type: 'collaborator', album: 'The Return' }
                ]
            }
        };

        let sampleData = {}; // Will be populated from API or fallback
        let network = null;
        let currentData = null;
        let apiToken = null;
        let useRealAPI = false;

        // API Integration Functions
        async function fetchArtistData(artistName) {
            if (!apiToken) {
                return fallbackData[artistName.toLowerCase().replace(/\s+/g, '-')] || 
                       { name: artistName, collaborations: [] };
            }

            try {
                showStatusMessage('Searching for ' + artistName, 'status');
                
                // Search for the artist
                const searchResponse = await fetch(
                    `https://api.discogs.com/database/search?q=${encodeURIComponent(artistName)}&type=artist&token=${apiToken}`
                );
                const searchData = await searchResponse.json();
                
                if (searchData.results && searchData.results.length > 0) {
                    const artistId = searchData.results[0].id;
                    
                    showStatusMessage('Found artist, fetching releases...', 'status');
                    
                    // Get artist's releases
                    const releasesResponse = await fetch(
                        `https://api.discogs.com/artists/${artistId}/releases?per_page=20&token=${apiToken}`
                    );
                    const releasesData = await releasesResponse.json();
                    
                    return {
                        name: artistName,
                        collaborations: await extractCollaborations(releasesData.releases || [], apiToken)
                    };
                } else {
                    showStatusMessage('No results found for ' + artistName, 'error');
                    return { name: artistName, collaborations: [] };
                }
            } catch (error) {
                console.log('Error fetching data:', error);
                showStatusMessage('API Error: ' + error.message, 'error');
                // Fallback to sample data
                return fallbackData[artistName.toLowerCase().replace(/\s+/g, '-')] || 
                       { name: artistName, collaborations: [] };
            }
        }

        async function extractCollaborations(releases, token) {
            const collaborations = [];
            
            showStatusMessage('Processing releases...', 'status');
            
            // Process first 5 releases to avoid rate limits
            for (let i = 0; i < Math.min(releases.length, 5); i++) {
                try {
                    const releaseResponse = await fetch(
                        `https://api.discogs.com/releases/${releases[i].id}?token=${token}`
                    );
                    const releaseData = await releaseResponse.json();
                    
                    if (releaseData.artists && isBritishJazz(releaseData)) {
                        releaseData.artists.forEach(artist => {
                            if (artist.name !== releases[i].artist) {
                                collaborations.push({
                                    artist: artist.name,
                                    type: 'performer',
                                    album: releaseData.title
                                });
                            }
                        });
                    }
                    
                    // Small delay to respect rate limits
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.log('Error processing release:', error);
                }
            }
            
            return collaborations;
        }

        function isBritishJazz(release) {
            const britishLabels = ['Brownswood', 'Jazz Re:freshed', 'On the Corner', 'Warp Records'];
            const jazzGenres = ['Jazz', 'Nu Jazz', 'Spiritual Jazz', 'UK Jazz'];
            
            const hasLabel = release.labels?.some(label => 
                britishLabels.some(british => label.name.includes(british))
            );
            
            const hasGenre = release.genres?.some(genre => 
                jazzGenres.includes(genre)
            );
            
            return hasLabel || hasGenre || (release.year && release.year >= 2010);
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.className = type === 'error' ? 'error-message' : 'status-message';
            statusDiv.textContent = message;
            
            // Clear status after 3 seconds
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        // Initialize the network
        function initNetwork() {
            const container = document.getElementById('network');
            const data = { nodes: [], edges: [] };
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 14,
                        color: '#ffffff',
                        face: 'Segoe UI'
                    },
                    borderWidth: 2,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.3)',
                        size: 5,
                        x: 2,
                        y: 2
                    }
                },
                edges: {
                    width: 2,
                    color: {
                        color: 'rgba(255, 255, 255, 0.3)',
                        highlight: 'rgba(255, 215, 0, 0.8)'
                    },
                    smooth: {
                        enabled: true,
                        type: 'continuous'
                    },
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.1)',
                        size: 2
                    }
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 150 },
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 120,
                        springConstant: 0.04
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: false
                },
                layout: {
                    improvedLayout: true
                }
            };

            network = new vis.Network(container, data, options);
            
            // Add click event listener
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showArtistInfo(nodeId);
                }
            });
        }

        // Generate network based on selected artist and filters
        async function generateNetwork() {
            const selectedArtist = document.getElementById('artistSelect').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const degrees = parseInt(document.getElementById('degreeSlider').value);
            const artistName = document.querySelector(`option[value="${selectedArtist}"]`).textContent;

            // Disable button during generation
            const generateBtn = document.getElementById('generateNetwork');
            generateBtn.disabled = true;

            // Show loading state
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = useRealAPI ? 'Fetching live data from Discogs' : 'Generating network';
            document.getElementById('network').appendChild(loadingDiv);

            try {
                // Fetch real data if we don't have it and API is enabled
                if (!sampleData[selectedArtist]) {
                    if (useRealAPI) {
                        sampleData[selectedArtist] = await fetchArtistData(artistName);
                    } else {
                        sampleData[selectedArtist] = fallbackData[selectedArtist] || { name: artistName, collaborations: [] };
                    }
                }
                
                const networkData = buildNetworkData(selectedArtist, roleFilter, degrees);
                updateNetwork(networkData);
                
                if (useRealAPI) {
                    showStatusMessage('Network generated successfully!', 'status');
                }
            } catch (error) {
                console.error('Error generating network:', error);
                showStatusMessage('Error generating network: ' + error.message, 'error');
            } finally {
                loadingDiv.remove();
                generateBtn.disabled = false;
            }
        }

        // Build network data from sample data
        function buildNetworkData(seedArtist, roleFilter, degrees) {
            const nodes = [];
            const edges = [];
            const processedArtists = new Set();
            const artistQueue = [{ id: seedArtist, degree: 0 }];

            // Color scheme for different artist types
            const colors = {
                seed: { background: '#ff6b6b', border: '#ff5252' },
                primary: { background: '#4ecdc4', border: '#26a69a' },
                secondary: { background: '#ffd700', border: '#ffc107' }
            };

            while (artistQueue.length > 0) {
                const current = artistQueue.shift();
                
                if (processedArtists.has(current.id) || current.degree > degrees) {
                    continue;
                }

                const artistData = sampleData[current.id];
                if (!artistData) continue;

                processedArtists.add(current.id);

                // Add node
                const nodeColor = current.degree === 0 ? colors.seed : 
                                current.degree === 1 ? colors.primary : colors.secondary;
                                
                nodes.push({
                    id: current.id,
                    label: artistData.name,
                    color: nodeColor,
                    size: current.degree === 0 ? 30 : 20 - (current.degree * 3),
                    font: { size: current.degree === 0 ? 16 : 14 }
                });

                // Process collaborations
                if (current.degree < degrees) {
                    artistData.collaborations.forEach(collab => {
                        // Apply role filter
                        if (roleFilter !== 'all' && collab.type !== roleFilter && 
                            !collab.type.includes(roleFilter)) {
                            return;
                        }

                        const collabId = collab.artist.toLowerCase().replace(/\s+/g, '-');
                        
                        // Add collaboration to queue if we have data for them
                        if (sampleData[collabId] && !processedArtists.has(collabId)) {
                            artistQueue.push({ id: collabId, degree: current.degree + 1 });
                        }

                        // Add edge
                        edges.push({
                            from: current.id,
                            to: collabId,
                            label: collab.type,
                            title: `${collab.album} (${collab.type})`
                        });
                    });
                }
            }

            return { nodes, edges };
        }

        // Update the network with new data
        function updateNetwork(data) {
            currentData = data;
            network.setData(data);
            network.fit();
        }

        // Show artist information panel
        function showArtistInfo(artistId) {
            const artistData = sampleData[artistId];
            if (!artistData) return;

            document.getElementById('defaultInfo').style.display = 'none';
            document.getElementById('artistInfo').classList.add('active');
            
            document.getElementById('selectedArtistName').textContent = artistData.name;
            
            const collaborationsList = document.getElementById('collaborationsList');
            collaborationsList.innerHTML = '';
            
            artistData.collaborations.forEach(collab => {
                const collabDiv = document.createElement('div');
                collabDiv.className = 'collaboration';
                collabDiv.innerHTML = `
                    <strong>${collab.artist}</strong><br>
                    <small>${collab.type} â€¢ ${collab.album}</small>
                `;
                collaborationsList.appendChild(collabDiv);
            });
        }

        // Event listeners
        document.getElementById('generateNetwork').addEventListener('click', generateNetwork);
        
        document.getElementById('degreeSlider').addEventListener('input', function(e) {
            document.getElementById('degreeValue').textContent = e.target.value;
        });

        document.getElementById('saveToken').addEventListener('click', function() {
            const token = document.getElementById('apiToken').value.trim();
            if (token) {
                apiToken = token;
                useRealAPI = true;
                showStatusMessage('API token saved! Now using live Discogs data.', 'status');
                // Clear existing sample data to force API calls
                sampleData = {};
            } else {
                apiToken = null;
                useRealAPI = false;
                sampleData = { ...fallbackData };
                showStatusMessage('Using demo data (no API token provided).', 'status');
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with fallback data
            sampleData = { ...fallbackData };
            initNetwork();
            generateNetwork(); // Generate initial network
        });
    </script>
</body>
</html>